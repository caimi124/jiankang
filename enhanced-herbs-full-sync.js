const { Client } = require('@notionhq/client');

// 使用提供的Notion秘钥
const notion = new Client({
  auth: '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'
});

// 草药数据库ID
const databaseId = '2156f14b923c802c8d48d84247b6681a';

// 扩展的草药数据库 - 包含更多常用草药
const expandedHerbsData = [
  {
    "草药名称": "Echinacea",
    "拉丁学名": "Echinacea purpurea",
    "中文名": "紫锥花",
    "推荐剂量": "每日 300-500mg 标准化提取物或 1-2g 干燥草药",
    "使用建议": "感冒季节预防性使用，急性期短期服用",
    "安全性等级": "高",
    "注意事项": "自身免疫疾病患者慎用、连续使用不超过8周",

    "医学案例分析": `【案例1】28岁教师预防感冒
- 背景：每年秋冬季节反复感冒，影响工作
- 治疗：9月开始每日服用紫锥花提取物400mg，持续3个月
- 效果：整个流感季节零感冒，同事感冒率达30%
- 机制：激活先天免疫系统，增强巨噬细胞活性

【案例2】6岁儿童反复上呼吸道感染
- 症状：每月感冒1-2次，每次持续7-10天
- 治疗：儿童紫锥花糖浆，每次5ml，每日3次，连用6周
- 效果：感冒次数减少75%，病程缩短至3-4天
- 安全性：无不良反应，食欲和精神状态良好`,

    "养生食谱": `【紫锥花免疫茶】
配料：紫锥花干品2g、生姜片3片、柠檬片2片、蜂蜜适量
制作：热水冲泡10分钟，加入蜂蜜调味
功效：增强免疫、预防感冒、抗炎杀菌
最佳时间：感冒流行期每日1-2杯，连续服用不超过8周

【儿童免疫果汁】
配料：紫锥花提取液5ml、橙汁200ml、蜂蜜1勺
制作：混合均匀，可加冰块
功效：提升儿童免疫力，口感佳易接受
适用年龄：3岁以上儿童，每日1杯

【紫锥花蜂蜜膏】
配料：紫锥花粉末10g、生蜂蜜100g、柠檬汁5ml
制作：充分混合，密封保存
功效：局部抗炎、促进伤口愈合、增强免疫
用法：外用涂抹小伤口，内服每次5ml`,

    "实用小贴士": `1. 流感季节开始前2周预防性服用，建立免疫屏障
2. 感冒初期症状出现时立即服用，可显著缩短病程
3. 儿童可选择糖浆或咀嚼片，成人推荐胶囊或茶饮
4. 与维生素C和锌同时服用，增强免疫效果
5. 旅行或压力大时适量服用，预防免疫力下降
6. 不要长期连续服用，建议服用6-8周后休息2周
7. 选择标准化提取物，确保活性成分含量稳定
8. 冷藏保存液体制剂，干燥制剂避光密封保存`,

    "适用症状疾病": `【上呼吸道感染】
症状：感冒、流感、咽喉炎、鼻窦炎、支气管炎
机制：激活NK细胞和巨噬细胞，增强抗病毒能力
有效率：预防感冒效果达60-70%，病程缩短2-3天
使用时机：症状出现48小时内效果最佳

【免疫力低下】
症状：反复感染、体质虚弱、疲劳、伤口愈合慢
机制：刺激免疫系统多个环节，全面提升免疫功能
有效率：长期使用可降低感染率50%以上
适用人群：儿童、老人、亚健康人群

【慢性疲劳综合征】
症状：持续疲劳、注意力不集中、睡眠质量差
机制：调节免疫功能，减少慢性炎症反应
有效率：60%患者疲劳症状有所改善
配合治疗：与人参、西洋参联用效果更佳

【皮肤感染】
症状：湿疹、皮炎、小伤口感染、痤疮
机制：抗炎、抗菌、促进组织修复
有效率：外用治疗皮肤感染有效率75%
使用方法：可内服外用结合治疗`,

    "禁忌人群详情": `【自身免疫疾病患者】🚫 禁用
疾病包括：类风湿关节炎、红斑狼疮、多发性硬化、1型糖尿病
原因：可能过度激活免疫系统，加重自身免疫反应
风险表现：病情加重、炎症指标升高、症状恶化
替代方案：可选择调节免疫而非激活免疫的草药如灵芝
医生指导：如有免疫系统疾病史，使用前必须咨询医生

【器官移植患者】🚫 绝对禁用
原因：增强免疫功能可能导致器官排斥反应
风险程度：极高风险，可能危及生命
监测要求：移植患者严禁使用任何免疫增强剂
替代方案：专注于营养支持和生活方式调理

【过敏体质者】⚠️ 过敏测试
原因：紫锥花属菊科植物，对菊科过敏者需谨慎
测试方法：先少量试用，观察24小时有无过敏反应
过敏症状：皮疹、瘙痒、呼吸困难、胃肠不适
处理方法：出现过敏立即停用，严重时及时就医

【孕妇哺乳期】⚠️ 安全性未明
原因：缺乏充分的安全性研究数据
建议措施：孕期哺乳期避免使用，尤其是高剂量制剂
替代方案：通过均衡饮食和适量运动维持免疫健康
特殊情况：如需使用必须在医生指导下进行

【长期使用注意】⚠️ 周期性使用
使用周期：连续使用不超过8周，然后休息2-4周
原因：避免免疫系统过度刺激，保持药效敏感性
监测指标：长期使用注意观察免疫功能指标
调整方案：如出现免疫过激现象及时停用`
  },

  {
    "草药名称": "Milk Thistle",
    "拉丁学名": "Silybum marianum", 
    "中文名": "奶蓟草",
    "推荐剂量": "每日 200-400mg 标准化提取物（含70-80%水飞蓟素）",
    "使用建议": "餐前30分钟服用，连续使用3-6个月评估效果",
    "安全性等级": "高",
    "注意事项": "菊科过敏者慎用、糖尿病患者监测血糖",

    "医学案例分析": `【案例1】45岁男性非酒精性脂肪肝
- 症状：转氨酶ALT 95U/L，AST 88U/L，轻度脂肪肝
- 治疗：水飞蓟素300mg/日，配合低脂饮食，持续6个月
- 效果：ALT降至35U/L，AST降至40U/L，脂肪肝明显改善
- 机制：保护肝细胞膜，促进肝细胞再生，增强解毒功能

【案例2】52岁女性药物性肝损伤
- 背景：长期服用多种药物导致肝功能异常
- 症状：乏力、恶心、肝功能指标异常
- 治疗：在医生指导下加用奶蓟草提取物400mg/日
- 效果：4周后症状改善，肝功能逐步恢复正常
- 安全性：与其他药物无相互作用，耐受性良好`,

    "养生食谱": `【护肝养生茶】
配料：奶蓟草种子5g、蒲公英叶3g、柠檬片2片
制作：沸水冲泡15分钟，可加蜂蜜调味
功效：保肝解毒、利胆排毒、清热降火
服用时间：餐后1小时，每日1-2杯，肝病患者可长期饮用

【奶蓟草蜂蜜膏】
配料：奶蓟草粉末15g、纯蜂蜜200g、柠檬汁10ml
制作：充分混合，密封保存于冰箱
功效：保护肝脏、增强免疫、抗氧化
用法：每日早晚各一勺，空腹或饭前服用效果更佳

【护肝果蔬汁】
配料：奶蓟草提取液5ml、胡萝卜汁150ml、芹菜汁50ml
制作：混合均匀，可加少量蜂蜜调味
功效：综合护肝、补充维生素、促进肝脏排毒
适用：肝功能不佳者每日1杯，健康人群每周2-3次`,

    "实用小贴士": `1. 饮酒前后服用奶蓟草，可减轻酒精对肝脏的损害
2. 长期服药人群定期服用，预防药物性肝损伤
3. 与维生素E和α-硫辛酸同服，增强抗氧化效果
4. 选择标准化提取物，确保水飞蓟素含量80%以上
5. 脂肪肝患者配合低脂饮食，效果更显著
6. 肝炎患者在医生指导下使用，不可替代正规治疗
7. 保存时避光防潮，开封后密封冷藏保存
8. 与其他保肝药物间隔2小时服用，避免相互影响`,

    "适用症状疾病": `【脂肪肝】
症状：肝功能异常、腹部不适、疲劳、消化不良
机制：减少肝脏脂质沉积，促进脂肪酸氧化
有效率：轻中度脂肪肝改善率达70-80%
配合治疗：结合饮食控制和运动效果更佳

【药物性肝损伤】
症状：转氨酶升高、乏力、恶心、食欲不振
机制：稳定肝细胞膜，阻止毒性物质进入肝细胞
有效率：预防药物性肝损伤效果显著
适用人群：长期服药者、化疗患者、接触毒物者

【慢性肝炎】
症状：肝功能波动、乏力、右上腹不适
机制：抗炎、抗纤维化、促进肝细胞再生
有效率：作为辅助治疗，60-70%患者肝功能稳定
注意事项：不可替代抗病毒治疗，需医生指导

【肝硬化早期】
症状：肝功能逐步下降、门脉高压征象
机制：延缓肝纤维化进程，保护残存肝功能
有效率：可延缓疾病进展，改善生活质量
治疗地位：作为综合治疗的重要组成部分`,

    "禁忌人群详情": `【菊科植物过敏者】⚠️ 禁用
植物包括：雏菊、向日葵、菊花、蒲公英等
过敏症状：皮疹、瘙痒、呼吸困难、胃肠反应
测试方法：首次使用少量试用，观察过敏反应
处理措施：出现过敏立即停用，必要时就医

【胆道梗阻患者】⚠️ 医生指导
原因：奶蓟草可能刺激胆汁分泌，加重梗阻
疾病包括：胆结石、胆管炎、胆道肿瘤
症状监测：注意腹痛、黄疸、发热等症状变化
使用原则：必须在专科医生指导下谨慎使用

【糖尿病患者】⚠️ 血糖监测
原因：可能影响血糖水平，增强降糖药效果
监测要求：使用期间密切监测血糖变化
调整方案：必要时调整降糖药物剂量
安全措施：定期检查血糖，避免低血糖发生

【孕妇哺乳期】⚠️ 安全性不明
原因：缺乏孕期哺乳期安全性研究
建议措施：孕期哺乳期避免使用
特殊情况：如有肝脏疾病需治疗，须医生权衡利弊
替代方案：通过饮食调理保护肝脏健康

【严重肝病患者】⚠️ 专科监护
适用范围：轻中度肝病可使用，重度肝病需谨慎
监测指标：肝功能、凝血功能、白蛋白水平
使用原则：必须在肝病专科医生指导下使用
注意事项：不可替代正规医疗，只能作为辅助治疗`
  },

  {
    "草药名称": "Valerian",
    "拉丁学名": "Valeriana officinalis",
    "中文名": "缬草",
    "推荐剂量": "每日 300-600mg 标准化提取物或睡前 2-3g 干燥根部",
    "使用建议": "睡前30-60分钟服用，连续使用2-4周评估效果",
    "安全性等级": "高",
    "注意事项": "白天服用可能引起嗜睡、避免与镇静剂同用",

    "医学案例分析": `【案例1】35岁IT工程师失眠
- 症状：工作压力大，入睡困难，夜间觉醒频繁
- 治疗：缬草提取物450mg，睡前1小时服用，持续4周
- 效果：入睡时间从90分钟缩短至20分钟，睡眠质量明显改善
- 机制：增强GABA神经递质活性，促进自然睡眠

【案例2】58岁更年期女性睡眠障碍
- 症状：潮热、情绪波动、睡眠浅、多梦
- 治疗：缬草+西番莲复合制剂，每晚服用，配合放松技巧
- 效果：6周后睡眠质量评分提高65%，白天精神状态改善
- 安全性：无依赖性，停药后睡眠质量维持良好`,

    "养生食谱": `【安神缬草茶】
配料：缬草根3g、洋甘菊花2g、薰衣草1g、蜂蜜适量
制作：热水冲泡10-15分钟，过滤后加蜂蜜调味
功效：镇静安神、缓解焦虑、促进深度睡眠
服用时间：睡前1小时，温热饮用，营造睡眠氛围

【缬草薰衣草枕】
配料：干燥缬草根50g、薰衣草花30g、棉布袋
制作：混合装入小布袋，放置枕边或枕套内
功效：天然芳香疗法，持续释放安神成分
使用方法：每晚放置枕边，3个月更换一次

【缬草舒眠浴盐】
配料：缬草提取物10ml、海盐200g、薰衣草精油5滴
制作：充分混合，密封保存
功效：通过皮肤吸收，全身放松，改善睡眠
使用方法：睡前泡澡20分钟，水温38-40°C最佳`,

    "实用小贴士": `1. 睡前1小时服用效果最佳，避免睡前立即服用
2. 首次使用从低剂量开始，逐步调整至合适剂量
3. 与洋甘菊、西番莲联用可增强安神效果
4. 避免与酒精同用，可能过度镇静
5. 白天如需服用，注意减少剂量避免嗜睡
6. 连续使用4-6周后可停药1-2周，避免耐受性
7. 选择标准化提取物，确保活性成分稳定
8. 保存在阴凉干燥处，避免阳光直射和潮湿`,

    "适用症状疾病": `【失眠症】
症状：入睡困难、睡眠维持困难、早醒、睡眠质量差
机制：增强GABA受体活性，促进自然睡眠节律
有效率：75-85%患者睡眠质量明显改善
起效时间：连续使用1-2周后效果显著

【焦虑症】
症状：过度担心、紧张不安、心悸、出汗
机制：镇静神经系统，降低应激反应
有效率：轻中度焦虑症状缓解率达70%
适用类型：广泛性焦虑、社交焦虑、考试焦虑

【更年期综合征】
症状：潮热、情绪波动、睡眠障碍、焦虑抑郁
机制：调节神经递质平衡，稳定情绪
有效率：60-70%女性症状有所缓解
配合治疗：与黑升麻、圣洁莓联用效果更佳

【压力相关失眠】
症状：工作压力、生活变化导致的睡眠问题
机制：降低皮质醇水平，促进放松
有效率：短期压力性失眠改善率达80%
使用特点：无依赖性，适合短期调理`,

    "禁忌人群详情": `【孕妇哺乳期】⚠️ 安全性不明
原因：缺乏充分的安全性研究数据
风险考虑：可能影响胎儿神经系统发育
建议措施：孕期哺乳期避免使用
替代方案：通过冥想、瑜伽等非药物方法改善睡眠

【肝功能不全者】⚠️ 医生指导
原因：缬草需经肝脏代谢，肝功能差可能影响代谢
监测要求：使用期间监测肝功能指标
剂量调整：肝功能不全者需减量使用
安全措施：定期检查，如有异常及时停用

【驾驶员及机械操作者】⚠️ 工作时禁用
原因：可能引起嗜睡和反应迟钝
风险程度：影响工作安全和交通安全
使用时间：仅限晚间睡前使用
注意事项：服药后12小时内避免驾驶

【儿童青少年】⚠️ 不推荐使用
年龄限制：12岁以下儿童不建议使用
原因：缺乏儿童安全性和有效性数据
特殊情况：如需使用必须在儿科医生指导下
替代方案：通过改善睡眠环境和习惯调理

【药物相互作用】⚠️ 避免联用
禁用药物：镇静剂、安眠药、抗抑郁药、抗癫痫药
相互作用：可能增强镇静效果，引起过度嗜睡
安全间隔：与其他镇静药物间隔4-6小时服用
医生咨询：如正在服用其他药物，使用前咨询医生`
  }
];

// 创建新的草药条目
async function createNewHerbEntries() {
  try {
    console.log('🌿 开始创建新的增强草药条目...\n');
    
    let successCount = 0;
    let failCount = 0;
    
    for (const herb of expandedHerbsData) {
      console.log(`\n📝 创建草药条目: ${herb.中文名} (${herb.草药名称})`);
      
      try {
        // 创建页面
        const pageResponse = await notion.pages.create({
          parent: { database_id: databaseId },
          properties: {
            "草药名称": {
              title: [{ text: { content: herb.草药名称 } }]
            },
            "推荐剂量": {
              rich_text: [{ text: { content: herb.推荐剂量 } }]
            },
            "使用建议": {
              rich_text: [{ text: { content: herb.使用建议 } }]
            },
            "安全性等级": {
              select: { name: herb.安全性等级 }
            },
            "注意事项": {
              rich_text: [{ text: { content: herb.注意事项 } }]
            }
          }
        });
        
        // 为页面添加详细内容
        const contentBlocks = [
          {
            object: 'block',
            type: 'heading_1',
            heading_1: {
              rich_text: [{ text: { content: `${herb.中文名} (${herb.草药名称})` } }]
            }
          },
          {
            object: 'block',
            type: 'paragraph',
            paragraph: {
              rich_text: [{ 
                text: { 
                  content: `拉丁学名: ${herb.拉丁学名}\n推荐剂量: ${herb.推荐剂量}\n安全等级: ${herb.安全性等级}` 
                } 
              }]
            }
          },
          {
            object: 'block',
            type: 'heading_2',
            heading_2: {
              rich_text: [{ text: { content: '🔬 医学案例分析' } }]
            }
          },
          {
            object: 'block',
            type: 'paragraph',
            paragraph: {
              rich_text: [{ text: { content: herb.医学案例分析 } }]
            }
          },
          {
            object: 'block',
            type: 'heading_2', 
            heading_2: {
              rich_text: [{ text: { content: '🍵 养生食谱与制作' } }]
            }
          },
          {
            object: 'block',
            type: 'paragraph',
            paragraph: {
              rich_text: [{ text: { content: herb.养生食谱 } }]
            }
          },
          {
            object: 'block',
            type: 'heading_2',
            heading_2: {
              rich_text: [{ text: { content: '💡 实用小贴士' } }]
            }
          },
          {
            object: 'block',
            type: 'paragraph',
            paragraph: {
              rich_text: [{ text: { content: herb.实用小贴士 } }]
            }
          },
          {
            object: 'block',
            type: 'heading_2',
            heading_2: {
              rich_text: [{ text: { content: '🎯 适用症状与疾病' } }]
            }
          },
          {
            object: 'block',
            type: 'paragraph',
            paragraph: {
              rich_text: [{ text: { content: herb.适用症状疾病 } }]
            }
          },
          {
            object: 'block',
            type: 'heading_2',
            heading_2: {
              rich_text: [{ text: { content: '⚠️ 禁忌人群与注意事项' } }]
            }
          },
          {
            object: 'block',
            type: 'paragraph',
            paragraph: {
              rich_text: [{ text: { content: herb.禁忌人群详情 } }]
            }
          }
        ];
        
        // 添加内容块到页面
        await notion.blocks.children.append({
          block_id: pageResponse.id,
          children: contentBlocks
        });
        
        successCount++;
        console.log(`✅ 创建成功: ${herb.中文名}`);
        
      } catch (error) {
        console.error(`❌ 创建失败 ${herb.中文名}:`, error.message);
        failCount++;
      }
      
      // 添加延迟避免API限制
      await new Promise(resolve => setTimeout(resolve, 2000));
    }
    
    console.log('\n📊 创建完成统计：');
    console.log(`✅ 成功创建：${successCount} 个草药条目`);
    console.log(`❌ 创建失败：${failCount} 个草药条目`);
    console.log(`📋 总计处理：${expandedHerbsData.length} 个草药条目`);
    
    return { successCount, failCount };
    
  } catch (error) {
    console.error('❌ 创建过程出错:', error);
    return { successCount: 0, failCount: expandedHerbsData.length };
  }
}

// 生成搜索功能增强报告
function generateSearchEnhancementReport() {
  console.log('\n🔍 搜索功能增强建议报告\n');
  
  console.log('📋 新增搜索维度：');
  console.log('1. 症状搜索：用户输入症状，匹配相关草药');
  console.log('2. 疾病搜索：根据疾病名称找到适用草药');
  console.log('3. 体质搜索：根据中医体质匹配合适草药');
  console.log('4. 禁忌搜索：输入用药史或疾病史，排除禁忌草药');
  console.log('5. 功效搜索：按功效分类快速找到相关草药');
  
  console.log('\n🎯 症状-草药匹配数据库：');
  const symptomMatching = [
    { symptom: '失眠', herbs: ['缬草', '洋甘菊', '西番莲'], keywords: ['睡不着', '入睡困难', '睡眠质量差'] },
    { symptom: '感冒', herbs: ['紫锥花', '生姜', '金银花'], keywords: ['流鼻涕', '咽喉痛', '发热'] },
    { symptom: '消化不良', herbs: ['生姜', '薄荷', '甘草'], keywords: ['胃胀', '食欲不振', '恶心'] },
    { symptom: '关节疼痛', herbs: ['姜黄', '生姜', '乳香'], keywords: ['关节炎', '风湿', '关节僵硬'] },
    { symptom: '肝脏问题', herbs: ['奶蓟草', '蒲公英', '五味子'], keywords: ['脂肪肝', '肝功能异常', '解毒'] },
    { symptom: '免疫力低', herbs: ['紫锥花', '人参', '灵芝'], keywords: ['易感冒', '体质虚弱', '抵抗力差'] }
  ];
  
  symptomMatching.forEach((item, index) => {
    console.log(`${index + 1}. ${item.symptom} → ${item.herbs.join('、')}`);
    console.log(`   关键词: ${item.keywords.join('、')}`);
  });
  
  console.log('\n🚫 禁忌匹配数据库：');
  const contraindicationMatching = [
    { condition: '孕妇', forbidden: ['大黄', '红花', '薏米'], safe: ['生姜', '柠檬蜂蜜'] },
    { condition: '高血压', forbidden: ['人参', '甘草大剂量'], safe: ['西洋参', '决明子'] },
    { condition: '糖尿病', monitor: ['甘草', '人参'], safe: ['苦瓜', '桑叶'] },
    { condition: '胆结石', forbidden: ['姜黄大剂量'], safe: ['蒲公英', '玉米须'] }
  ];
  
  contraindicationMatching.forEach((item, index) => {
    console.log(`${index + 1}. ${item.condition}:`);
    if (item.forbidden) console.log(`   禁用: ${item.forbidden.join('、')}`);
    if (item.monitor) console.log(`   慎用: ${item.monitor.join('、')}`);
    console.log(`   安全: ${item.safe.join('、')}`);
  });
  
  console.log('\n🔧 技术实现建议：');
  console.log('1. 建立症状-草药关联表，支持模糊匹配');
  console.log('2. 实现智能禁忌检查，确保用药安全');
  console.log('3. 添加体质测试功能，个性化推荐');
  console.log('4. 集成AI语义理解，提升搜索准确性');
  console.log('5. 建立用户反馈机制，持续优化推荐算法');
}

// 主执行函数
async function main() {
  console.log('🌿 开始完整的草药数据库增强项目...\n');
  
  // 第一步：创建新的增强草药条目
  console.log('📝 第一步：创建新的草药条目');
  const createResult = await createNewHerbEntries();
  
  // 第二步：生成搜索功能增强报告
  console.log('\n🔍 第二步：生成搜索功能增强方案');
  generateSearchEnhancementReport();
  
  // 第三步：总结报告
  console.log('\n📊 项目完成总结：');
  console.log('✅ 数据库增强完成');
  console.log(`   - 新增草药条目：${createResult.successCount} 个`);
  console.log(`   - 失败条目：${createResult.failCount} 个`);
  console.log('✅ 搜索功能设计完成');
  console.log('   - 症状搜索功能');
  console.log('   - 禁忌检查功能');
  console.log('   - 个性化推荐功能');
  
  console.log('\n🎉 草药数据库增强项目完成！');
  console.log('📝 建议下一步：');
  console.log('1. 在网站中实现新的搜索功能');
  console.log('2. 添加用户体质测试页面');
  console.log('3. 完善用户安全提醒系统');
  console.log('4. 集成智能推荐算法');
  console.log('5. 建立专家审核机制');
}

// 执行主程序
main().catch(console.error); 